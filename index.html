<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kovaze Mushroom Hunt ‚Äì Smart Scanner</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b1020;color:#e9eefc;margin:0}
h1{margin:0;font-size:28px;text-align:center;padding:20px 10px;color:#7df57d}
main{max-width:900px;margin:0 auto;padding:10px}
section{background:#121a34;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid rgba(255,255,255,.06)}
input,button{font-size:15px;border-radius:8px;padding:8px 10px;border:1px solid rgba(255,255,255,.1);background:#0e1732;color:#e9eefc}
button{cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}
#log{background:#0a1228;min-height:220px;max-height:400px;overflow:auto;font-family:monospace;padding:10px;border-radius:8px}
.hit{padding:8px;border:1px solid rgba(125,245,125,.4);border-radius:8px;background:rgba(125,245,125,.07);margin:6px 0}
a{color:#8cd0ff}
.stats{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;font-size:14px}
.stat{background:#0e1732;border:1px solid rgba(255,255,255,.05);padding:5px 9px;border-radius:6px}
label{display:inline-block;margin:4px 8px 8px 0}
</style>
</head>
<body>
<h1>üçÑ Kovaze Mushroom Hunt</h1>
<main>
<section>
<label>Start ID <input id="start" type="number" value="1" min="1"></label>
<label>End ID <input id="end" type="number" value="25000" min="1"></label>
<label>Concurrency <input id="conc" type="number" value="12" min="1" max="64"></label>
<label>Delay (ms) <input id="delay" type="number" value="150" min="0"></label>
<div style="margin-top:10px">
  <button id="startBtn">Start Scan</button>
  <button id="stopBtn" disabled>Stop</button>
  <button id="clearBtn">Clear Log</button>
  <button id="exportBtn" disabled>Export Hits</button>
</div>
<div class="stats">
  <span class="stat">Checked: <b id="checked">0</b></span>
  <span class="stat">Hits: <b id="hits">0</b></span>
  <span class="stat">Progress: <b id="prog">0%</b></span>
  <span class="stat">Elapsed: <b id="elapsed">00:00</b></span>
</div>
</section>

<section>
<h3>Found Mushrooms</h3>
<div id="found"></div>
</section>

<section>
<h3>Log</h3>
<div id="log"></div>
</section>
</main>

<script>
(() => {
  // Always query by ID (don‚Äôt rely on implicit globals)
  const $ = (id) => document.getElementById(id);

  // Elements
  const startEl = $('start');
  const endEl = $('end');
  const concEl = $('conc');
  const delayEl = $('delay');
  const startBtn = $('startBtn');
  const stopBtn = $('stopBtn');
  const clearBtn = $('clearBtn');
  const exportBtn = $('exportBtn');
  const logEl = $('log');
  const foundEl = $('found');
  const checkedEl = $('checked');
  const hitsEl = $('hits');
  const progEl = $('prog');
  const elapsedEl = $('elapsed');

  // The GIF id fragments you shared
  const idFrags = [
    "39B70122","42F1D780","5C8837E9","F01F3FFC",
    "2512485C","423E20D4","F42229EE","F0689D5F"
  ];
  const MUSHROOM_RE = new RegExp(idFrags.join('|'), 'i');

  // State
  let running = false;
  let controllers = new Set();
  let checked = 0;
  let hits = 0;
  let startTime = 0;

  // Utils
  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logEl.innerHTML += `[${t}] ${msg}<br>`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function fmt(sec) {
    const m = String(Math.floor(sec/60)).padStart(2,'0');
    const s = String(Math.floor(sec%60)).padStart(2,'0');
    return `${m}:${s}`;
  }
  function enableExportIfHits() { exportBtn.disabled = hits === 0; }

  function addHit(id, line) {
    const url = `https://kovaze.com/blog/${id}`;
    hits++;
    hitsEl.textContent = String(hits);
    enableExportIfHits();

    const div = document.createElement('div');
    div.className = 'hit';
    div.innerHTML = `<b>Found:</b> <a href="${url}" target="_blank" rel="noopener">${url}</a><br>
                     <small>${(line || 'match').replace(/</g,'&lt;')}</small>`;
    foundEl.prepend(div);
    log(`üçÑ Hit at /blog/${id}`);
  }

  function fetchWithTimeout(url, ms, ctl) {
    const timer = setTimeout(() => ctl.abort(), ms);
    return fetch(url, { signal: ctl.signal })
      .finally(() => clearTimeout(timer));
  }

  async function checkOne(id) {
    const ctl = new AbortController();
    controllers.add(ctl);
    try {
      // Use read-only proxy to bypass CORS
      const res = await fetchWithTimeout(`https://r.jina.ai/http://kovaze.com/blog/${id}`, 12000, ctl);
      if (!res.ok) return;
      const html = await res.text();

      // Prefer scanning <img ... .gif> tags; fall back to whole HTML
      const onlyImgs = (html.match(/<img[^>]+src="[^"]+\.gif"[^>]*>/gi) || []).join('\n');
      const haystack = onlyImgs || html;

      if (MUSHROOM_RE.test(haystack)) {
        const line = (onlyImgs.match(/<img[^>]+src="[^"]+\.gif"[^>]*>/i) || [haystack.slice(0,180)])[0];
        addHit(id, line);
      }
    } catch (e) {
      // ignore aborts/errors to keep pool moving
    } finally {
      controllers.delete(ctl);
    }
  }

  async function startScan() {
    if (running) return;
    running = true;
    controllers.clear();

    startBtn.disabled = true;
    stopBtn.disabled = false;
    exportBtn.disabled = true;

    hits = 0; checked = 0;
    hitsEl.textContent = '0';
    checkedEl.textContent = '0';
    progEl.textContent = '0%';
    foundEl.innerHTML = '';

    startTime = Date.now();
    const s = Math.max(1, Number(startEl.value || 1));
    const e = Math.max(s, Number(endEl.value || s));
    const c = Math.max(1, Math.min(64, Number(concEl.value || 8)));
    const d = Math.max(0, Number(delayEl.value || 0));
    const total = e - s + 1;

    log(`Starting scan ${s} ‚Üí ${e}  (concurrency=${c}, delay=${d}ms)`);

    const queue = Array.from({ length: total }, (_, i) => s + i);

    const worker = async () => {
      while (running && queue.length) {
        const id = queue.shift();
        await checkOne(id);
        checked++;
        checkedEl.textContent = String(checked);
        progEl.textContent = Math.min(100, Math.round(checked / total * 100)) + '%';
        elapsedEl.textContent = fmt((Date.now() - startTime) / 1000);
        if (d) await new Promise(r => setTimeout(r, d));
      }
    };

    await Promise.all(Array.from({ length: c }, worker));

    running = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    log('Scan complete.');
  }

  function stopScan() {
    if (!running) return;
    running = false;
    controllers.forEach(c => { try { c.abort(); } catch {} });
    controllers.clear();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    log('Stopped.');
  }

  function clearAll() {
    logEl.innerHTML = '';
    foundEl.innerHTML = '';
    hits = 0; checked = 0;
    hitsEl.textContent = '0';
    checkedEl.textContent = '0';
    progEl.textContent = '0%';
    elapsedEl.textContent = '00:00';
    enableExportIfHits();
    log('Cleared.');
  }

  function exportHits() {
    if (!hits) return;
    const rows = [['id','url']];
    [...foundEl.querySelectorAll('a')].forEach(a => {
      const id = a.href.split('/').pop();
      rows.push([id, a.href]);
    });
    const csv = rows.map(r => r.map(x => `"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'mushroom_hits.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Wire up events
  startBtn.addEventListener('click', startScan);
  stopBtn.addEventListener('click', stopScan);
  clearBtn.addEventListener('click', clearAll);
  exportBtn.addEventListener('click', exportHits);

  // Friendly boot log
  log('Ready. Set your range and press Start.');
})();
</script>
</body>
</html>